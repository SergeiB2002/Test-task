# Задание 3: архитектура

![Схема архитектуры отправки PUSH уведомлений](/Task%203/push%20architecture.drawio.png)

## Ключевые компоненты

1. **Бэкенд (микросервисы)** — источники событий. Их задача — при наступлении важного события (например, «заказ отменен») опубликовать структурированное сообщение в общую шину событий (Event Bus).
2. **Шина событий (Event Bus).** Обычно это Apache Kafka или RabbitMQ. Её задачи:
   - Буферизация: Гарантирует, что ни одно событие не будет потеряно, даже если сервис уведомлений временно недоступен.
   - Масштабируемость: Позволяет легко добавлять новых "подписчиков" на события.
3. **Сервис уведомлений** — главный исполнительный компонент. Его основные задачи:
   - Подписка на события: Получает события из шины.
   - Создание уведомления: Берет шаблон сообщения, подставляет данные (имя, номер заказа) и формирует финальный текст.
   - Управление токенами: Следит за актуальными токенами устройства пользователя (обновляются при каждом входе в приложение) и обеспечивает адресацию.
   - Отправка во внешние сервисы: Передает сформированное уведомление в FCM (для Android) или APNs (для iOS).
4. **Внешние сервисы доставки (FCM/APNs)** — специализированные платформы Google и Apple, которые гарантированно доставляют уведомления на мобильные устройства.

### Дополнительные компоненты сервиса уведомлений:
1. **Сервис пользовательских предпочтений (User Preference).**

Позволяет пользователям контролировать получение уведомлений. Он хранит индивидуальные предпочтения пользователей относительно получения уведомлений. Сервис отслеживает, на получение каких типов уведомлений пользователи явно согласились или отказались.

Чтобы предотвратить перегрузку пользователей уведомлениями, сервис устанавливает ограничения на частоту получения определенных типов уведомлений, особенно рекламных сообщений.

2. **Сервис планирования (Schedule)**

Отвечает за хранение и отслеживание запланированных уведомлений — уведомлений, которые необходимо отправить в определенное время в будущем.

Как только наступит запланированное время, служба планировщика извлекает уведомление из своего хранилища и отправляет его в очередь уведомлений.

3. **Очередь уведомлений**

Действует как буфер между сервисом уведомлений и сервисом доставки. 

Разделяя отправку запроса на уведомление и его доставку, очередь позволяет системе масштабироваться гораздо эффективнее, особенно в периоды высокой нагрузки. Система очередей гарантирует доставку сообщений.
